<html>
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Juicebox</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <!-- Font Awesome CSS-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">

    <!-- Juicebox CSS-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/aidenlab/juicebox.js@dat-modernize/dist/css/juicebox.css">

</head>

<body>
<h1>Dynamic load example</h1>

This example illustrates the use of the juicebox API to dynamically load a map and tracks from menu actions.

<div style="margin-top: 50px;">
    <h2>Step 1: Select a hic file to load</h2>
    <label for="hic-select"><span style="font-size: large;font-weight: bold">Contact Matrix (.hic file)</span></label>
    <select id="hic-select">
        <option value="">None</option>
        <option value="https://www.encodeproject.org/files/ENCFF718AWL/@@download/ENCFF718AWL.hic">GM12878</option>
        <option value="https://www.encodeproject.org/files/ENCFF406HHC/@@download/ENCFF406HHC.hic">K562</option>
    </select>
</div>

<div style="margin-top: 50px;margin-bottom: 50px">
    <h2>Step 2: Load tracks</h2>
    <div style="margin-bottom: 20px;">
        <label for="tracks-select"><span style="font-size: large;font-weight: bold">Predefined Tracks</span></label>
        <select id="tracks-select" disabled>
            <option value="">None</option>
            <option value="GM12878">GM12878 CTCF</option>
            <option value="K562">K562 CTCF</option>
        </select>
    </div>
    <div style="margin-top: 20px;">
        <label for="track-url-input"><span style="font-size: large;font-weight: bold">Or Load Custom Track: URL or Local File</span></label>
        <div style="margin-top: 10px;">
            <input type="text" id="track-url-input" placeholder="Enter track URL (e.g., .bigWig, .bed, .wig, .bedpe)" style="width: 400px; padding: 5px;">
            <input type="file" id="track-file-input" accept=".bigwig,.bigWig,.bed,.wig,.bedpe,.interact" style="margin-left: 10px;">
            <button id="load-track-btn" style="margin-left: 10px; padding: 5px 15px;">Load Track</button>
        </div>
        <div style="margin-top: 10px;">
            <small><strong>Note:</strong> Local track files will not be saved in session files. A warning will be shown when saving.</small>
        </div>
    </div>
</div>

<div style="margin-top: 50px;margin-bottom: 50px">
    <h2>Step 3: Save Session (Test Warning)</h2>
    <div style="margin-top: 10px;">
        <button id="save-session-btn" style="padding: 5px 15px;">Save Session (Test Local File Warning)</button>
    </div>
    <div style="margin-top: 10px;">
        <small><strong>Note:</strong> Click this button to test the local file warning. If you've loaded local files (tracks or Hi-C maps), a warning will appear.</small>
        <br>
        <small>The session JSON will be logged to the console. Local files will be excluded from the saved session.</small>
    </div>
</div>

<div style="margin-top: 50px;margin-bottom: 50px">
    <h2>Step 4: Load Session File (Optional)</h2>
    <label for="session-input"><span style="font-size: large;font-weight: bold">Session File URL or Local File</span></label>
    <div style="margin-top: 10px;">
        <input type="text" id="session-input" placeholder="Enter session file URL or select local file" style="width: 400px; padding: 5px;">
        <input type="file" id="session-file-input" accept=".json" style="margin-left: 10px;">
        <button id="load-session-btn" style="margin-left: 10px; padding: 5px 15px;">Load Session</button>
    </div>
    <div style="margin-top: 10px;">
        <small>You can load a session file to restore a previous Juicebox state with tracks, zoom level, and other settings.</small>
        <br>
        <small><strong>Note:</strong> Session loading will override any currently loaded Hi-C files and tracks.</small>
        <br>
        <small><strong>Supported URLs:</strong> Dropbox URLs are automatically converted to direct download links.</small>
        <br>
        <small><strong>Sample:</strong> You can test with a sample session file that includes GM12878 data and tracks.</small>
    </div>
</div>


<div id="app-container"></div>


<script type="module">

    // import juicebox from '../js/index.js';
    import juicebox from "https://cdn.jsdelivr.net/gh/aidenlab/juicebox.js@dat-modernize/dist/juicebox.esm.js"

    const config = {}

    const container = document.getElementById("app-container");

    juicebox.init(container, config)
        .then(function (hicBrowser) {
            console.log("Juicebox loaded");
            initMenus(hicBrowser);
        })


    function initMenus(hicBrowser) {
        const hicSelect = document.getElementById("hic-select");
        const tracksSelect = document.getElementById("tracks-select");
        const trackUrlInput = document.getElementById("track-url-input");
        const trackFileInput = document.getElementById("track-file-input");
        const loadTrackBtn = document.getElementById("load-track-btn");
        const saveSessionBtn = document.getElementById("save-session-btn");
        const sessionInput = document.getElementById("session-input");
        const sessionFileInput = document.getElementById("session-file-input");
        const loadSessionBtn = document.getElementById("load-session-btn");

        hicSelect.onchange = async (e) => {
            const idx = hicSelect.selectedIndex;
            const option = hicSelect.options[idx];
            const currentBrowser = juicebox.getCurrentBrowser();
            if (currentBrowser) {
                await currentBrowser.loadHicFile({url: option.value});
                tracksSelect.removeAttribute("disabled")
            }
        }

        tracksSelect.onchange = (e) => {
            const idx = tracksSelect.selectedIndex;
            const option = tracksSelect.options[idx];
            const trackConfig = trackDictionary[option.value];
            const currentBrowser = juicebox.getCurrentBrowser();
            if (currentBrowser) {
                currentBrowser.loadTracks([trackConfig]);
            }
        }

        // Handle track file input change
        trackFileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                trackUrlInput.value = file.name;
            }
        }

        // Handle custom track loading
        loadTrackBtn.onclick = async (e) => {
            try {
                const currentBrowser = juicebox.getCurrentBrowser();
                if (!currentBrowser) {
                    alert("Please load a Hi-C file first.");
                    return;
                }

                let trackConfig;

                // Check if a local file is selected
                if (trackFileInput.files.length > 0) {
                    const file = trackFileInput.files[0];
                    trackConfig = {
                        name: file.name,
                        url: file,  // Pass File object directly
                        autoscale: true
                    };
                } else if (trackUrlInput.value.trim()) {
                    // Load from URL
                    const url = trackUrlInput.value.trim();
                    trackConfig = {
                        name: url.substring(url.lastIndexOf('/') + 1) || 'Custom Track',
                        url: url,
                        autoscale: true
                    };
                } else {
                    alert("Please enter a track URL or select a local track file.");
                    return;
                }

                await currentBrowser.loadTracks([trackConfig]);
                console.log("Track loaded successfully");
                
                // Clear inputs after successful load
                trackUrlInput.value = '';
                trackFileInput.value = '';
                
            } catch (error) {
                console.error("Error loading track:", error);
                alert(`Error loading track: ${error.message}`);
            }
        }

        // Handle save session button
        saveSessionBtn.onclick = (e) => {
            try {
                const sessionJSON = juicebox.toJSON();
                console.log("Session JSON:", JSON.stringify(sessionJSON, null, 2));
                
                // Optionally download as file
                const blob = new Blob([JSON.stringify(sessionJSON, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'juicebox-session.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log("Session saved to file: juicebox-session.json");
            } catch (error) {
                console.error("Error saving session:", error);
                alert(`Error saving session: ${error.message}`);
            }
        }

        // Handle session file input change
        sessionFileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                sessionInput.value = file.name;
            }
        }

        // Handle session loading
        loadSessionBtn.onclick = async (e) => {
            try {
                let sessionData;
                
                // Check if a local file is selected
                if (sessionFileInput.files.length > 0) {
                    const file = sessionFileInput.files[0];
                    const text = await file.text();
                    sessionData = JSON.parse(text);
                } else if (sessionInput.value.trim()) {
                    // Load from URL using Juicebox's igvxhr (handles Dropbox URLs properly)
                    const url = sessionInput.value.trim();
                    const response = await juicebox.igvxhr.loadString(url);
                    sessionData = JSON.parse(response);
                } else {
                    alert("Please enter a session file URL or select a local file.");
                    return;
                }

                // Load the session using the correct API
                await juicebox.restoreSession(container, sessionData);
                console.log("Session loaded successfully");
                
                // Get the updated browser instance after session restore
                const updatedBrowser = juicebox.getCurrentBrowser();
                if (updatedBrowser) {
                    // Enable tracks select if it was disabled
                    tracksSelect.removeAttribute("disabled");
                }
                
            } catch (error) {
                console.error("Error loading session:", error);
                alert(`Error loading session: ${error.message}`);
            }
        }

    }


    // Define a couple of track configurations
    const trackDictionary = {

        "GM12878": {
            "name": "GM12878 CTCF ",
            "url": "https://www.encodeproject.org/files/ENCFF000ARJ/@@download/ENCFF000ARJ.bigWig",
            "autoscale": true,
            "displayMode": "COLLAPSED",
            "format": "bigwig",
            "color": "rgb(0,150,0)",
            "height": 40
        },
        "K562": {
            "name": "K562 CTCF ",
            "url": "https://www.encodeproject.org/files/ENCFF000YMA/@@download/ENCFF000YMA.bigWig",
            "autoscale": true,
            "displayMode": "COLLAPSED",
            "format": "bigwig",
            "color": "rgb(0, 150, 0)",
            "height": 40
        }
    }

    const t = []


</script>

</body>

</html>
